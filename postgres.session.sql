SELECT ST_DistanceSphere(
    ST_GeomFromText('POINT(-38.9736 -12.2663)', 4326),
    ST_GeomFromText('POINT(-40.5177 -11.1819)', 4326)
) AS distance;

-- @block
SELECT Count(srid) FROM spatial_ref_sys;


-- @block
SELECT ST_DistanceSphere(
    ST_GeomFromText('POINT(-38.5023 -12.9716)', 0),
    ST_GeomFromText('POINT(-46.6333 -23.5505)', 0)
) AS distance;

-- @block
WITH tagged_nodes AS (
    SELECT n.node_id, n.location
    FROM nodes n
    WHERE n.node_id IN (
        SELECT DISTINCT nt1.node_id
        FROM node_tags nt1
        WHERE nt1.tag_key = 'power' AND nt1.tag_value = 'tower'
    )
)
SELECT
    nt1.node_id AS node_id_1,
    nt2.node_id AS node_id_2,
    ST_DistanceSphere(nt1.location::geometry, nt2.location::geometry) AS distance
FROM
    tagged_nodes nt1
CROSS JOIN
    tagged_nodes nt2
WHERE
    nt1.node_id != nt2.node_id
ORDER BY
    distance ASC
LIMIT 1;

-- @block
-- SELECT
--     ST_DistanceSphere(
--         ST_MakePoint(0, 0),
--         ST_MakePoint(180, 0)
--     ) AS longitudinal_around_half_the_globe,
--     ST_DistanceSphere(
--         ST_MakePoint(0, 0),
--         ST_MakePoint(180, 0)
--     ) / pi() AS ratio_of_the_globe;

SELECT distance, distance/pi() AS ratio_of_the_globe
FROM 
    (SELECT
        ST_DistanceSphere(
            ST_GeomFromText('POINT(0 0)', 0),
            ST_GeomFromText('POINT(180 0)', 0)
        ) AS distance
    ) AS subquery;

-- @block

SELECT distance, distance/pi() AS ratio_of_the_globe
FROM 
    (SELECT
        ST_DistanceSphere(
            ST_GeomFromText('POINT(0 0)', 0),
            ST_GeomFromText('POINT(180 0)', 0)
        ) AS distance
    ) AS subquery;



-- @block
-- SELECT n.node_id
-- FROM nodes n
-- WHERE st_contains(n.location:: geometry,  ST_GeomFromText('POLYGON((-38.9544101 -12.2319633,-38.9543055 -12.2319752,-38.9541152 -12.231997,-38.9535663 -12.2320539,-38.9534972 -12.232065,-38.9534884 -12.2318442,-38.9534549 -12.231084,-38.9534468 -12.230832,-38.9534641 -12.2308043,-38.953496 -12.2302764,-38.9534802 -12.2299272,-38.9534743 -12.2297955,-38.9534518 -12.2295581,-38.9534449 -12.2292068,-38.9534054 -12.2288095,-38.953371 -12.2284643,-38.9533628 -12.2283522,-38.9533506 -12.2281846,-38.9533043 -12.2278209,-38.9532514 -12.2275365,-38.953114 -12.227131,-38.9529907 -12.2267233,-38.9528649 -12.2262489,-38.9526784 -12.2256148,-38.9525992 -12.2253551,-38.952495 -12.2250246,-38.9524026 -12.2247517,-38.9523591 -12.2246339,-38.9522551 -12.2243522,-38.9522051 -12.2241915,-38.9521573 -12.2240378,-38.9521076 -12.223878,-38.952092 -12.22378,-38.9520853 -12.223742,-38.9520397 -12.2234706,-38.9519827 -12.2226351,-38.9519679 -12.2223598,-38.9519465 -12.22204,-38.951896 -12.2214245,-38.9518609 -12.2208422,-38.9518326 -12.2203586,-38.95182 -12.2201431,-38.9517255 -12.219117,-38.9518558 -12.219157,-38.9519947 -12.2192095,-38.9526891 -12.2194152,-38.9545016 -12.2199818,-38.9550973 -12.220177,-38.9560368 -12.2204984,-38.956424 -12.2206247,-38.9573549 -12.2209217,-38.9574235 -12.2209453,-38.9577308 -12.2210573,-38.9579079 -12.2211215,-38.9579567 -12.2211373,-38.9580164 -12.2211524,-38.9579848 -12.2212225,-38.9583469 -12.2213384,-38.9585771 -12.2214181,-38.9587644 -12.22147,-38.9591788 -12.2216068,-38.9595865 -12.2217563,-38.9598681 -12.2218402,-38.9600108 -12.221883,-38.9604179 -12.2220053,-38.9606037 -12.2220545,-38.9608263 -12.2221253,-38.9615116 -12.2223389,-38.9615722 -12.2223591,-38.9616887 -12.2223979,-38.9618467 -12.2224545,-38.9619142 -12.2224797,-38.9621925 -12.2225546,-38.9623473 -12.2225956,-38.9624184 -12.222621,-38.9627796 -12.2227503,-38.9631253 -12.2228594,-38.9633645 -12.2229338,-38.9635385 -12.222998,-38.9639435 -12.2231384,-38.9644069 -12.2233079,-38.9646376 -12.2233681,-38.9648951 -12.2234415,-38.9650614 -12.223494,-38.965107 -12.2235281,-38.9652089 -12.2235962,-38.9651179 -12.224233,-38.9650335 -12.2246718,-38.9650098 -12.2248684,-38.9649744 -12.2251614,-38.9649547 -12.225412,-38.9649407 -12.2255918,-38.9648761 -12.2260671,-38.9648493 -12.2262652,-38.9648131 -12.2264375,-38.9647942 -12.2265652,-38.964764 -12.2267433,-38.9647279 -12.226956,-38.9646829 -12.2272211,-38.964571 -12.2275821,-38.9645285 -12.2277191,-38.9645051 -12.2278242,-38.9644637 -12.2280008,-38.9644225 -12.2282228,-38.9643035 -12.2288649,-38.9642382 -12.2292561,-38.9641913 -12.2294094,-38.9641189 -12.2295313,-38.9640585 -12.2296165,-38.9639285 -12.2298094,-38.963867 -12.2298452,-38.9638236 -12.2298789,-38.9637743 -12.2299235,-38.9636938 -12.2300441,-38.963667 -12.2301004,-38.9636415 -12.2301948,-38.9636281 -12.2302721,-38.9636234 -12.2303298,-38.9636247 -12.2304012,-38.9636273 -12.230441,-38.9636347 -12.2304782,-38.9636503 -12.2305198,-38.9636635 -12.2305538,-38.9637722 -12.2306958,-38.9635075 -12.2306774,-38.9633652 -12.2306815,-38.9632096 -12.230725,-38.9630152 -12.2307761,-38.9628435 -12.230822,-38.9626457 -12.23086,-38.962118 -12.230938,-38.961483 -12.2310284,-38.9609425 -12.231109,-38.960346 -12.2311861,-38.9602713 -12.2311951,-38.9597253 -12.2312608,-38.9590858 -12.2313419,-38.9577358 -12.2315391,-38.9573084 -12.2315842,-38.9561403 -12.2317798,-38.9556612 -12.2318601,-38.9555692 -12.2318731,-38.9551658 -12.2319448,-38.9547116 -12.2319035,-38.954518 -12.2319417,-38.9544101 -12.2319633))', 4326):: geometry);

-- SELECT ST_AsText(n.location) FROM nodes n where node_id = 1658258357

SELECT ST_Intersects(ST_GeomFromText('POINT(-12.225241 -38.9645581)', 0),  ST_GeomFromText('POLYGON((-12.2319633 -38.9544101,-12.2319752 -38.9543055,-12.231997 -38.9541152,-12.2320539 -38.9535663,-12.232065 -38.9534972,-12.2318442 -38.9534884,-12.231084 -38.9534549,-12.230832 -38.9534468,-12.2308043 -38.9534641,-12.2302764 -38.953496,-12.2299272 -38.9534802,-12.2297955 -38.9534743,-12.2295581 -38.9534518,-12.2292068 -38.9534449,-12.2288095 -38.9534054,-12.2284643 -38.953371,-12.2283522 -38.9533628,-12.2281846 -38.9533506,-12.2278209 -38.9533043,-12.2275365 -38.9532514,-12.227131 -38.953114,-12.2267233 -38.9529907,-12.2262489 -38.9528649,-12.2256148 -38.9526784,-12.2253551 -38.9525992,-12.2250246 -38.952495,-12.2247517 -38.9524026,-12.2246339 -38.9523591,-12.2243522 -38.9522551,-12.2241915 -38.9522051,-12.2240378 -38.9521573,-12.223878 -38.9521076,-12.22378 -38.952092,-12.223742 -38.9520853,-12.2234706 -38.9520397,-12.2226351 -38.9519827,-12.2223598 -38.9519679,-12.22204 -38.9519465,-12.2214245 -38.951896,-12.2208422 -38.9518609,-12.2203586 -38.9518326,-12.2201431 -38.95182,-12.219117 -38.9517255,-12.219157 -38.9518558,-12.2192095 -38.9519947,-12.2194152 -38.9526891,-12.2199818 -38.9545016,-12.220177 -38.9550973,-12.2204984 -38.9560368,-12.2206247 -38.956424,-12.2209217 -38.9573549,-12.2209453 -38.9574235,-12.2210573 -38.9577308,-12.2211215 -38.9579079,-12.2211373 -38.9579567,-12.2211524 -38.9580164,-12.2212225 -38.9579848,-12.2213384 -38.9583469,-12.2214181 -38.9585771,-12.22147 -38.9587644,-12.2216068 -38.9591788,-12.2217563 -38.9595865,-12.2218402 -38.9598681,-12.221883 -38.9600108,-12.2220053 -38.9604179,-12.2220545 -38.9606037,-12.2221253 -38.9608263,-12.2223389 -38.9615116,-12.2223591 -38.9615722,-12.2223979 -38.9616887,-12.2224545 -38.9618467,-12.2224797 -38.9619142,-12.2225546 -38.9621925,-12.2225956 -38.9623473,-12.222621 -38.9624184,-12.2227503 -38.9627796,-12.2228594 -38.9631253,-12.2229338 -38.9633645,-12.222998 -38.9635385,-12.2231384 -38.9639435,-12.2233079 -38.9644069,-12.2233681 -38.9646376,-12.2234415 -38.9648951,-12.223494 -38.9650614,-12.2235281 -38.965107,-12.2235962 -38.9652089,-12.224233 -38.9651179,-12.2246718 -38.9650335,-12.2248684 -38.9650098,-12.2251614 -38.9649744,-12.225412 -38.9649547,-12.2255918 -38.9649407,-12.2260671 -38.9648761,-12.2262652 -38.9648493,-12.2264375 -38.9648131,-12.2265652 -38.9647942,-12.2267433 -38.964764,-12.226956 -38.9647279,-12.2272211 -38.9646829,-12.2275821 -38.964571,-12.2277191 -38.9645285,-12.2278242 -38.9645051,-12.2280008 -38.9644637,-12.2282228 -38.9644225,-12.2288649 -38.9643035,-12.2292561 -38.9642382,-12.2294094 -38.9641913,-12.2295313 -38.9641189,-12.2296165 -38.9640585,-12.2298094 -38.9639285,-12.2298452 -38.963867,-12.2298789 -38.9638236,-12.2299235 -38.9637743,-12.2300441 -38.9636938,-12.2301004 -38.963667,-12.2301948 -38.9636415,-12.2302721 -38.9636281,-12.2303298 -38.9636234,-12.2304012 -38.9636247,-12.230441 -38.9636273,-12.2304782 -38.9636347,-12.2305198 -38.9636503,-12.2305538 -38.9636635,-12.2306958 -38.9637722,-12.2306774 -38.9635075,-12.2306815 -38.9633652,-12.230725 -38.9632096,-12.2307761 -38.9630152,-12.230822 -38.9628435,-12.23086 -38.9626457,-12.230938 -38.962118,-12.2310284 -38.961483,-12.231109 -38.9609425,-12.2311861 -38.960346,-12.2311951 -38.9602713,-12.2312608 -38.9597253,-12.2313419 -38.9590858,-12.2315391 -38.9577358,-12.2315842 -38.9573084,-12.2317798 -38.9561403,-12.2318601 -38.9556612,-12.2318731 -38.9555692,-12.2319448 -38.9551658,-12.2319035 -38.9547116,-12.2319417 -38.954518,-12.2319633 -38.9544101))', 0)) AS r

-- @block
-- SELECT 